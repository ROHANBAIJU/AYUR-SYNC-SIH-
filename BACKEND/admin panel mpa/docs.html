<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NAMASTE-ICD | API Docs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="image.png" type="image/png" />
  <style>
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:0.5rem; }
    .endpoint-group code { background:#f1f5f9; padding:2px 6px; border-radius:4px; font-size:12px; }
    .http-get { color:#059669; font-weight:600; }
    .http-post { color:#2563eb; font-weight:600; }
    .http-put { color:#d97706; font-weight:600; }
    .http-delete { color:#dc2626; font-weight:600; }
    .badge { font-size:10px; line-height:1; padding:3px 6px; border-radius:9999px; background:#e0e7ff; color:#4338ca; }
    .dark-mode .endpoint-group code { background:#132033; border:1px solid #2b3a52; }
  </style>
</head>
<body class="h-full">
  <div id="app-screen" class="h-full flex flex-col">
    <div id="admin-nav"></div>
    <header class="bg-white p-4 border-b border-gray-200 flex justify-between items-center">
      <h1 class="text-xl font-bold text-gray-800">API & System Documentation</h1>
      <div class="flex items-center gap-3">
        <button id="logout-button" class="text-sm font-medium text-gray-700 hover:text-red-600">Logout</button>
      </div>
    </header>
    <main class="flex-1 p-6 space-y-8 max-w-7xl mx-auto w-full">

      <!-- Architecture / Flowchart -->
      <section class="card p-4" id="architecture">
        <div class="bg-gradient-to-r from-indigo-50 to-teal-50 -m-4 mb-4 p-4 border-b rounded-t-lg">
          <h2 class="text-xl font-bold text-gray-800">High‑Level Flow & Components</h2>
          <p class="text-sm text-gray-600">Concept discovery → curation → verification → clinician usage & analytics.</p>
        </div>
        <div class="space-y-4">
          <img src="image.png" alt="System Flowchart" class="block mx-auto rounded border" style="width:70%;height:auto;" />
          <ul class="text-sm text-gray-700 list-disc pl-5 space-y-1">
            <li><strong>Ingestion</strong>: Raw AYUSH morbidity CSVs parsed → staging tables.</li>
            <li><strong>AI Discovery</strong>: Suggests primary + alias candidates per ICD with justification & confidence.</li>
            <li><strong>Curation</strong>: Admin resolves suggestions (primary / alias / reject).</li>
            <li><strong>Master Map (Staged → Verified)</strong>: Promotion exposes mappings to public & FHIR endpoints.</li>
            <li><strong>Clinician APIs</strong>: Lookup / Translate unify ICD ↔ TM systems.</li>
            <li><strong>FHIR APIs</strong>: CodeSystem / ConceptMap / ValueSet / $operations.</li>
            <li><strong>Analytics</strong>: Access log aggregation + geospatial clustering.</li>
          </ul>
        </div>
      </section>

      <!-- Authentication -->
      <section class="card p-4" id="auth">
        <h2 class="text-lg font-semibold mb-3 text-gray-800">Authentication</h2>
        <p class="text-sm text-gray-600 mb-3">Bearer token required for all <code>/api/admin/*</code> and protected <code>/api/fhir/*</code> endpoints.</p>
        <ul class="text-sm text-gray-700 list-disc pl-5 mb-3 space-y-1">
          <li><strong>JWT</strong> — Obtain via <code>POST /api/auth/token</code> (form body: <code>username</code>, <code>password</code>).</li>
          <li><strong>Mock ABHA</strong> — Use header <code>Authorization: Bearer ABHA_demo</code> (demo shortcut; HMAC / OAuth planned).</li>
        </ul>
        <p class="text-xs text-gray-500 mb-4">Tip: Smoke script uses <code>--use-abha</code> to skip JWT issuance.</p>
        <ul class="text-sm text-gray-700 space-y-2 endpoint-group">
          <li><span class="http-post">POST</span> <code>/api/auth/token</code> <span class="badge">Auth</span> — returns <code>access_token</code>.</li>
          <li><span class="http-post">POST</span> <code>/api/auth/logout</code> — (optional) client discard.</li>
        </ul>
      </section>

      <!-- Public Clinician Endpoints -->
      <section class="card p-4" id="clinician">
        <h2 class="text-lg font-semibold mb-3 text-gray-800">Clinician / Public Endpoints</h2>
        <p class="text-sm text-gray-600 mb-3">Return only <strong>verified</strong> mappings. Append <code>&release=v1-submission</code> for reproducible historical results.</p>
        <ul class="text-sm text-gray-700 space-y-2 endpoint-group">
          <li><span class="http-get">GET</span> <code>/api/public/lookup?query=&lt;text&gt;</code> — Substring search across ICD + traditional terms.</li>
          <li><span class="http-get">GET</span> <code>/api/public/translate?icd_name=&lt;ICD_NAME&gt;</code> — ICD → grouped traditional systems (forward, WHO enrich).</li>
          <li><span class="http-get">GET</span> <code>/api/public/translate?system=&lt;sys&gt;&code=&lt;code|term&gt;</code> — Traditional system concept → ICD (reverse).</li>
          <li><span class="http-get">GET</span> <code>/api/public/translate/reverse?icd_name=&lt;ICD_NAME&gt;</code> — Reverse variant (minimal WHO calls).</li>
          <li><span class="http-get">GET</span> <code>/api/public/verified-icd</code> — All ICD names with at least one verified mapping.</li>
          <li><span class="http-get">GET</span> <code>/api/public/mapping-search?q=&lt;frag&gt;</code> — Suggestion-style quick search.</li>
          <li><span class="http-get">GET</span> <code>/api/public/translate/cache/stats</code> — Cache hit / miss stats.</li>
        </ul>
        <p class="text-xs text-gray-500 mt-3">WHO MMS / TM2 lookup is best-effort; missing code/definition may populate later and persist.</p>
      </section>

      <!-- FHIR Endpoints -->
      <section class="card p-4" id="fhir">
        <h2 class="text-lg font-semibold mb-3 text-gray-800">FHIR Terminology Endpoints</h2>
        <p class="text-sm text-gray-600 mb-2">R4 subset: CodeSystem, ValueSet, ConceptMap operations, provenance & ingest prototype.</p>
        <ul class="text-sm text-gray-700 space-y-2 endpoint-group">
          <li><span class="http-get">GET</span> <code>/api/fhir/metadata</code> — CapabilityStatement (+ release extensions).</li>
          <li><span class="http-get">GET</span> <code>/api/fhir/CodeSystem/{system}</code> — Read (content: not-present).</li>
          <li><span class="http-get">GET</span> <code>/api/fhir/CodeSystem/$lookup?system=&lt;sys&gt;&code=&lt;code&gt;</code> — Concept details (optionally release-scoped).</li>
          <li><span class="http-get">GET</span> <code>/api/fhir/ValueSet/$expand?system=&lt;sys&gt;</code> — Expansion (supports <code>release=</code>).</li>
          <li><span class="http-get">GET</span> <code>/api/fhir/ConceptMap/$translate?system=&lt;sys&gt;&code=&lt;code&gt;</code> — Primary translation (Parameters).</li>
          <li><span class="http-get">GET</span> <code>/api/fhir/ConceptMap/translate?system=&lt;sys&gt;&code=&lt;code&gt;</code> — Alias path (for proxies blocking <code>$</code>).</li>
          <li><span class="http-get">GET</span> <code>/api/admin/conceptmap/releases/{ver}/fhir</code> — Export snapshot as FHIR ConceptMap.</li>
          <li><span class="http-get">GET</span> <code>/api/fhir/provenance/conceptmap?icd_name=&lt;ICD&gt;</code> — Mapping provenance.</li>
          <li><span class="http-get">GET</span> <code>/api/fhir/provenance/release/{version}</code> — Release provenance bundle.</li>
          <li><span class="http-post">POST</span> <code>/api/fhir/Bundle</code> — Condition ingest prototype (dual coding validation).</li>
        </ul>
        <p class="text-xs text-gray-500 mt-3">Use <code>&release=v1-submission</code> on lookup / expand / translate for frozen snapshots; omit for latest.</p>
      </section>

      <!-- Admin / Curation -->
      <section class="card p-4" id="admin">
        <h2 class="text-lg font-semibold mb-3 text-gray-800">Admin / Curation Endpoints</h2>
        <ul class="text-sm text-gray-700 space-y-2 endpoint-group">
          <li><span class="http-get">GET</span> <code>/api/admin/all-suggestions</code> — All AI suggested mappings grouped by ICD.</li>
          <li><span class="http-post">POST</span> <code>/api/admin/submit-curation</code> — Persist curated decisions (suggested → staged or rejected).</li>
          <li><span class="http-post">POST</span> <code>/api/admin/curation-audit-log</code> — (Best‑effort) record auto / bulk UI actions.</li>
          <li><span class="http-get">GET</span> <code>/api/admin/master-map-data</code> — Aggregated staged + verified (primary + aliases) rows.</li>
          <li><span class="http-post">POST</span> <code>/api/admin/commit-to-master</code> — Promote all staged mappings → verified.</li>
          <li><span class="http-post">POST</span> <code>/api/admin/update-master-mapping</code> — Edit a single ICD/system curated mapping (primary + aliases upsert/delete).</li>
          <li><span class="http-post">POST</span> <code>/api/admin/verify-mapping-with-ai</code> — Run AI justification & directly verify a primary.</li>
          <li><span class="http-post">POST</span> <code>/api/admin/verify</code> / <code>/api/admin/force-verify</code> — Lightweight verify flows.</li>
          <li><span class="http-post">POST</span> <code>/api/admin/undo-verification</code> — Revert verified → staged for an ICD.</li>
          <li><span class="http-get">GET</span> <code>/api/admin/rejected-mappings</code> — Rejected pools (correction / orphanage).</li>
          <li><span class="http-post">POST</span> <code>/api/admin/remap-rejected-term</code> — Move a rejected term to a new / existing ICD with AI re‑analysis.</li>
          <li><span class="http-post">POST</span> <code>/api/admin/reset-curation</code> — Wipe mappings & rediscover suggestions.</li>
          <li><span class="http-get">GET</span> <code>/api/admin/stats</code> — High‑level counts (suggested / staged / verified / rejected).</li>
          <li><span class="http-get">GET</span> <code>/api/admin/completeness-stats</code> — Multi‑system coverage distribution.</li>
          <li><span class="http-get">GET</span> <code>/api/admin/debug/icd-mappings?icd_name=...</code> — Raw mappings per ICD (debug aid).</li>
        </ul>
      </section>

      <!-- Releases / Versioning (ConceptMap) -->
      <section class="card p-4" id="releases">
        <h2 class="text-lg font-semibold mb-3 text-gray-800">ConceptMap Releases</h2>
        <ul class="text-sm text-gray-700 space-y-2 endpoint-group">
          <li><span class="http-get">GET</span> <code>/api/admin/conceptmap/releases</code> — List (version, element counts).</li>
          <li><span class="http-get">GET</span> <code>/api/admin/conceptmap/releases/latest</code> — Latest pointer.</li>
          <li><span class="http-get">GET</span> <code>/api/admin/conceptmap/releases/{version}/elements</code> — Enumerate elements (filter <code>?icd_name=</code>).</li>
          <li><span class="http-get">GET</span> <code>/api/admin/conceptmap/releases/{version}/diff?from=prev</code> — Diff stub (structure ready).</li>
          <li><span class="http-get">GET</span> <code>/api/admin/conceptmap/releases/{version}/fhir</code> — Export FHIR ConceptMap (<code>&summary=true</code> for counts only).</li>
          <li><span class="http-post">POST</span> <code>/api/admin/conceptmap/releases/{version}/refresh</code> — Rebuild snapshot from current verified mappings.</li>
        </ul>
        <p class="text-xs text-gray-500 mt-3">Workflow: curate & verify → refresh snapshot → test with <code>&release=</code> → export for downstream systems.</p>
      </section>

      <!-- Analytics Endpoints -->
      <section class="card p-4" id="analytics">
        <h2 class="text-lg font-semibold mb-3 text-gray-800">Analytics Endpoints</h2>
        <ul class="text-sm text-gray-700 space-y-2 endpoint-group">
          <li><span class="http-get">GET</span> <code>/api/admin/analytics/summary</code> — Totals + status buckets + latency.</li>
          <li><span class="http-get">GET</span> <code>/api/admin/analytics/timeseries?bucket=minute|hour&limit=60</code> — Time buckets.</li>
          <li><span class="http-get">GET</span> <code>/api/admin/analytics/paths?limit=50</code> — Top paths with latency & status breakdown.</li>
          <li><span class="http-get">GET</span> <code>/api/admin/analytics/recent?limit=100</code> — Most recent requests (raw log entries).</li>
          <li><span class="http-get">GET</span> <code>/api/admin/analytics/map/clusters?bbox=..&zoom=..</code> — Spatial clusters.</li>
          <li><span class="http-get">GET</span> <code>/api/admin/analytics/map/details?lat=..&lng=..</code> — Detail for cluster area.</li>
        </ul>
      </section>

      <!-- Error Format -->
      <section class="card p-4" id="errors">
        <h2 class="text-lg font-semibold mb-3 text-gray-800">Error Model</h2>
        <p class="text-sm text-gray-700 mb-2">Errors follow a JSON envelope (non‑FHIR) or <code>OperationOutcome</code> (FHIR ops):</p>
<pre class="text-xs bg-gray-50 border rounded p-3 overflow-auto">{
  "detail": "Human readable message",
  "code": "optional_error_code"
}</pre>
        <p class="text-xs text-gray-500 mt-2">Not-found / validation failures in FHIR endpoints produce <code>OperationOutcome.issue[]</code> entries.</p>
      </section>

      <!-- Rate Limits / Performance -->
      <section class="card p-4" id="perf">
        <h2 class="text-lg font-semibold mb-3 text-gray-800">Performance Notes</h2>
        <ul class="text-sm text-gray-700 list-disc pl-5 space-y-1">
          <li>Translation responses cached per (release, direction, key) — inspect via <code>/api/public/translate/cache/stats</code>.</li>
          <li>WHO enrichment persisted lazily; cache warms organically or via scripted pre-hit.</li>
          <li>Snapshot export avoids repeated large data joins for downstream consumers.</li>
          <li>Geospatial analytics uses bounding box + zoom heuristics for server efficiency.</li>
          <li>AI suggestion + verification flows are idempotent; bulk commits batched.</li>
        </ul>
      </section>

      <section class="card p-4" id="demo">
        <h2 class="text-lg font-semibold mb-3 text-gray-800">Quick Demo Path</h2>
        <ol class="list-decimal pl-5 text-sm text-gray-700 space-y-1">
          <li>List snapshot: <code>/api/admin/conceptmap/releases</code></li>
          <li>Forward translate (snapshot): <code>/api/public/translate?icd_name=Abdominal%20distension&release=v1-submission</code></li>
          <li>Reverse translate: <code>/api/public/translate/reverse?icd_name=Abdominal%20distension&release=v1-submission</code></li>
          <li>Export ConceptMap: <code>/api/admin/conceptmap/releases/v1-submission/fhir</code></li>
          <li>Provenance (mapping): <code>/api/fhir/provenance/conceptmap?icd_name=Abdominal%20distension</code></li>
          <li>Run smoke script: <code>python BACKEND/scripts/smoke_test.py --release v1-submission --system ayurveda --code "SM31(AAC-12)" --use-abha</code></li>
        </ol>
        <p class="text-xs text-gray-500 mt-3">All green & reproducible translation confirms submission readiness.</p>
      </section>

    </main>
  </div>
  <script src="config.js"></script>
  <script src="admin_nav.js"></script>
  <script src="docs_examples.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      const token = localStorage.getItem('accessToken');
      if(!token) window.location.href='index.html';
      const logout = document.getElementById('logout-button');
      if(logout) logout.addEventListener('click', ()=>{ localStorage.removeItem('accessToken'); window.location.href='index.html'; });
    });
  </script>
  <style>
    .ex-inline { border:1px solid #e5e7eb; border-radius:6px; background:#f8fafc; }
    .ex-inline summary { cursor:pointer; list-style:none; padding:4px 10px; font-size:11px; font-weight:600; color:#334155; letter-spacing:.25px; }
    .ex-inline summary::-webkit-details-marker { display:none; }
    .ex-inline[open] summary { background:#eef2ff; color:#1e3a8a; border-bottom:1px solid #e0e7ff; border-top-left-radius:6px; border-top-right-radius:6px; }
    .ex-inline pre { margin:0; padding:10px 12px; background:#0f172a; color:#f1f5f9; font-size:12px; line-height:1.45; overflow:auto; border-bottom-left-radius:6px; border-bottom-right-radius:6px; }
    .ex-download-btn { background:#1e3a8a; color:#fff; font-size:10px; padding:4px 8px; border-radius:4px; border:none; cursor:pointer; box-shadow:0 1px 2px rgba(0,0,0,0.08); }
    .ex-download-btn:hover { background:#1d4ed8; }
    /* Accordion Enhancements */
    .ex-acc { border:1px solid #e5e7eb; border-radius:8px; background:linear-gradient(135deg,#f8fafc,#f1f5f9); position:relative; overflow:hidden; }
    .ex-acc + .ex-acc { margin-top:6px; }
    .ex-acc-header { width:100%; display:flex; align-items:center; gap:8px; padding:6px 10px; background:transparent; border:none; cursor:pointer; font-size:11px; font-weight:600; color:#334155; text-align:left; position:relative; transition:background .25s, color .25s; }
    .ex-acc.open .ex-acc-header { background:#eef2ff; color:#1e3a8a; }
    .ex-acc-header:focus-visible { outline:2px solid #6366f1; outline-offset:2px; }
    .ex-acc-arrow { display:inline-flex; transition:transform .35s cubic-bezier(.65,.05,.36,1); color:#64748b; }
    .ex-acc.open .ex-acc-arrow { transform:rotate(180deg); color:#1e3a8a; }
    .ex-acc-badge { margin-left:auto; background:#e0e7ff; color:#4338ca; font-size:9px; padding:3px 6px; border-radius:9999px; letter-spacing:.5px; font-weight:600; box-shadow:0 0 0 1px rgba(67,56,202,0.15); }
    .ex-acc-panel { background:#0f172a; color:#f1f5f9; font-size:12px; line-height:1.45; overflow:hidden; max-height:0; opacity:0; transition:max-height .45s cubic-bezier(.65,.05,.36,1), opacity .35s ease; border-top:1px solid #e0e7ff; }
    .ex-acc-panel pre { margin:0; padding:10px 14px 14px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .ex-acc-toolbar { display:flex; justify-content:flex-end; padding:6px 8px 4px; gap:8px; background:#1e293b; border-bottom:1px solid #334155; }
    .endpoint-group li { position:relative; }
    .endpoint-group li .ex-acc { margin-top:4px; box-shadow:0 2px 4px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06); }
    .endpoint-group li:hover .ex-acc:not(.open) { border-color:#d1d5db; }
    @media (hover:hover){
      .ex-acc-header:hover { background:#f1f5f9; }
      .ex-acc.open .ex-acc-header:hover { background:#e0e7ff; }
    }
    /* Subtle glow when opening */
    .ex-acc.open { box-shadow:0 4px 10px -2px rgba(30,58,138,0.25), 0 2px 4px rgba(0,0,0,0.08); }
  </style>
</body>
</html>
